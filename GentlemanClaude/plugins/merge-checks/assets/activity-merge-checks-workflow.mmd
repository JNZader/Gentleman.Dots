flowchart TD
    Start(["/merge-checks invoked"])

    subgraph Phase0["Phase 0 â€” Scope Selection"]
        direction LR
        GC["âš™ï¸ gather-context.sh<br/>~100ms git state"]
        HasArg{Explicit<br/>argument?}
        Obvious{Obvious<br/>case?}
        Ask["ğŸ“¨ AskUserQuestion<br/>tailored options"]
        Scope["ğŸ’¾ Scope resolved"]

        GC --> HasArg
        HasArg -->|Yes| Scope
        HasArg -->|No| Obvious
        Obvious -->|Auto-proceed| Scope
        Obvious -->|Ambiguous| Ask
        Ask --> Scope
    end

    subgraph Phase1["Phase 1 â€” Mechanical Checks"]
        direction LR
        Precompute["âš™ï¸ precompute.sh"]
        DetectMode["detect-mode"]
        DetectFeatures["detect-features"]
        Manifest["build-manifest"]
        Parallel1["âš™ï¸ Per-file checks<br/>stories Â· tests Â· i18n Â· debug<br/>suppressions Â· env Â· routes<br/>migrations Â· seeds Â· shared"]

        Precompute --> DetectMode --> DetectFeatures --> Manifest --> Parallel1
    end

    subgraph Phase2["Phase 2 â€” Reasoning Agents (concurrent)"]
        direction LR
        AgentA["ğŸ¤– A â€” Docs"]
        AgentB["ğŸ¤– B â€” Comments"]
        AgentC["ğŸ¤– C â€” Shared contracts"]
    end

    subgraph Phase3["Phase 3 â€” Compile with Retry"]
        direction LR
        Aggregate["âš™ï¸ Aggregate<br/>Phase 1 + Phase 2"]
        Coverage{Coverage<br/>gaps?}
        Retry["ğŸ”„ Retry<br/>missed files"]
        Format["âš™ï¸ Format<br/>sort by severity"]

        Aggregate --> Coverage
        Coverage -->|No gaps| Format
        Coverage -->|Files missed| Retry
        Retry --> Aggregate
    end

    Report(["âœ… Prioritized issue report grouped by file"])

    Start --> Phase0
    Phase0 --> Phase1
    Phase1 --> Phase2
    Phase2 --> Phase3
    Phase3 --> Report
